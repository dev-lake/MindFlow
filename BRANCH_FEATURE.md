# 分支功能说明

## 新增功能

### 1. 鼠标悬停添加分支
当鼠标悬停在节点上时，如果该节点没有输入节点子节点，会在节点底部中央显示一个绿色的"+"按钮。点击该按钮可以从当前节点创建一个新的分支。

**显示条件:**
- 节点没有输入节点(input)类型的子节点
- 对于对话节点，需要AI已完成回复
- 不在发送消息过程中

**适用节点类型:**
- 对话节点(conversation) - 需要AI已完成回复
- 用户节点(user)
- AI助手节点(assistant)

**使用方法:**
1. 将鼠标移动到节点上
2. 等待绿色"+"按钮出现在节点底部
3. 点击"+"按钮
4. 系统会自动创建一个新的输入节点作为分支

**注意:** 如果节点已经有输入节点子节点，加号按钮不会显示，避免创建多余的输入节点。

### 2. 从选中文本创建分支
在有多个子节点的节点中选择文本时，除了原有的"引用"按钮外，还会显示"新分支"按钮。

**触发条件:**
- 节点必须有2个或更多子节点(hasMultipleChildren)
- 在节点内选中文本

**使用方法:**
1. 在有多个分支的节点中选择文本
2. 会出现两个按钮:
   - 蓝色"引用"按钮 - 将选中文本引用到现有输入节点
   - 绿色"新分支"按钮 - 创建新分支并引用选中文本
3. 点击"新分支"按钮
4. 系统会:
   - 设置引用内容
   - 创建新的输入节点作为分支
   - 自动选中新节点

### 3. 输入节点可关闭和拖动
输入节点现在可以通过关闭按钮删除（root节点除外），并且可以拖动移动位置。

**拖动功能:**
1. 输入节点顶部有一个带有抓手图标的标题栏
2. 鼠标悬停在标题栏上会显示移动光标
3. 点击并拖动标题栏可以移动输入节点位置

**关闭功能:**
1. 在输入节点标题栏的右侧有一个"X"关闭按钮
2. 点击关闭按钮
3. 输入节点及其所有子节点会被删除
4. 自动选中父节点

**注意:** root节点（第一个输入节点）不能被关闭，但可以拖动。

## 技术实现

### 状态管理
- `isHovering`: 跟踪鼠标悬停状态
- `hasMultipleChildren`: 检查节点是否有多个子节点
- `hasInputChild`: 检查节点的子节点中是否已有输入节点
- `shouldShowAddButton`: 综合判断是否应该显示加号按钮

### 核心函数
- `createBranchNode()`: 创建新的分支节点
  - 智能计算新分支的位置，避免与现有节点重合
  - 如果已有子节点，找到最下方子节点的Y坐标
  - 根据子节点类型估算其高度：
    - 对话节点(conversation): 600px
    - 输入节点(input): 300px
    - 其他节点: 200px
  - 新节点放在最下方子节点下方，位置 = 子节点Y + 估算高度 + 100px间距
  - X轴根据子节点数量模3偏移（0, 300, 600循环），避免完全重叠
  - 如果没有子节点，默认在父节点下方200px

- `handleAddBranchFromSelection()`: 从选中文本创建分支
  - 提取选中文本和上下文
  - 设置引用内容
  - 调用createBranchNode创建分支

- `handleCloseInputNode()`: 关闭输入节点
  - 检查节点是否为输入节点且不是root
  - 调用deleteNode删除节点

- `deleteNode()`: 删除节点（在chatStore中）
  - 从父节点的children中移除
  - 递归删除所有子节点
  - 更新数据库
  - 选中父节点

### UI组件
- 悬停按钮: 绿色圆形按钮，带Plus图标
- 分支按钮: 绿色矩形按钮，带GitBranch图标
- 关闭按钮: 灰色X图标，位于输入节点标题栏右侧
- 拖动手柄: 输入节点标题栏，带有GripVertical图标，使用 `drag-handle` 类
- 使用animate-fadeIn动画效果

## 图标
- `Plus` (lucide-react): 用于悬停添加按钮
- `GitBranch` (lucide-react): 用于文本选择分支按钮
- `X` (lucide-react): 用于关闭输入节点按钮
- `GripVertical` (lucide-react): 用于拖动手柄图标
